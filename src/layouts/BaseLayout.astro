---
import { sanityClient, urlFor, type Profile } from '../lib/sanityClient';

interface Props {
  title: string;
  description?: string;
}

const { title, description = "Handcrafted pottery with soul" } = Astro.props;
const currentPath = Astro.url.pathname;
const baseUrl = import.meta.env.BASE_URL;

// Helper to create proper links for both dev and production
const link = (path: string) => {
  if (baseUrl === '/') return path;
  return `${baseUrl}${path}`;
};

// Fetch profile for logo, favicon, and newsletter
const profile = await sanityClient.fetch<Profile>(
  "*[_type == 'profile' && _id == 'profile'][0] { _id, logo, favicon, buttondownUsername }"
);

const buttondownUsername = profile?.buttondownUsername || 'YOUR_USERNAME_HERE';

// Generate favicon URL - use custom favicon if provided, otherwise use logo
const faviconUrl = profile?.favicon?.asset
  ? urlFor(profile.favicon).width(64).format('png').url()
  : profile?.logo?.asset
  ? urlFor(profile.logo).width(56).height(56).fit('max').pad(4).bg('faf9f6').format('png').url()
  : `${import.meta.env.BASE_URL}favicon.svg`;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" href={faviconUrl} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=Inter:wght@300;400&display=swap"
      rel="stylesheet"
    />
    <title>{title}</title>
    <script>
      import '../lib/sentry';
    </script>
    <link rel="stylesheet" href="/src/styles/global.css" />
    <style is:global>
      /* Softened Color Palette with CSS Variables */
      :root {
        --color-bg: #F5F2ED;      /* Warm Bone */
        --color-text-main: #45413E; /* Warm Stone */
        --color-text-muted: #918C86; /* Warm Taupe */
        --color-line: #DEDAD4;     /* Deep Bone */
      }

      /* Global CSS Health Fixes */
      html {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background-color: var(--color-bg);
        color: var(--color-text-main);
      }

      body {
        background-color: var(--color-bg);
        color: var(--color-text-main);
      }

      /* Typography */
      .font-serif {
        font-family: "Cormorant Garamond", serif;
        font-style: italic;
      }

      h1, h2, h3, h4 {
        font-family: "Cormorant Garamond", serif;
        font-style: italic;
        color: var(--color-text-main);
      }

      nav a, .metadata, .uppercase {
        font-family: "Inter", sans-serif;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        font-size: 0.7rem;
        font-weight: 300;
        color: var(--color-text-main);
      }

      /* Subtle image fade-in */
      img {
        opacity: 1;
        transition: opacity 0.6s ease-in-out;
      }

      /* Date and Location Labels */
      .date-label, .location-label {
        color: var(--color-text-muted);
      }

      /* Unified Ghost Button Component */
      .btn-zen {
        background-color: transparent;
        color: var(--color-text-main);
        border: 1px solid var(--color-text-main);
        padding: 0.875rem 3rem;
        font-size: 0.625rem;
        text-transform: uppercase;
        letter-spacing: 0.4em;
        transition: all 700ms ease-in-out;
      }

      .btn-zen:hover {
        background-color: var(--color-text-main);
        color: var(--color-bg);
      }
    </style>
  </head>
  <body class="min-h-screen bg-[var(--color-bg)] font-sans antialiased" style="color: var(--color-text-main);">
    <!-- Horizontal minimalist navigation -->
    <nav class="w-full py-8 px-4 md:px-8 sticky top-0 z-50 backdrop-blur-sm bg-opacity-100" style="background-color: var(--color-bg);">
      <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
        <!-- Brand name/logo on left -->
        <a href={link('/')} class="group flex-shrink min-w-0 mr-auto">
          <div class="flex items-start gap-1.5 md:gap-[1.1rem]">
            {profile?.logo?.asset && (
              <img
                src={urlFor(profile.logo).width(200).format('webp').quality(90).url()}
                alt="Logo"
                class="h-8 md:h-12 w-auto opacity-40 -mt-1 md:-mt-2 flex-shrink-0"
              />
            )}
            <div class="min-w-0">
              <h1 class="font-medium uppercase font-sans leading-tight transition-colors group-hover:opacity-70" style="font-size: 24px; color: #45413E; letter-spacing: 0.15em;">
                Yufang Zhang
              </h1>
              <p class="text-[9px] md:text-[10px] uppercase tracking-museum mt-2 md:mt-4" style="color: var(--color-text-muted);">
                Ceramic Artist
              </p>
            </div>
          </div>
        </a>

        <!-- Mobile menu button -->
        <button
          id="mobile-menu-button"
          class="md:hidden p-2 flex-shrink-0 ml-auto"
          style="color: var(--color-text-main);"
          aria-label="Toggle menu"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>

        <!-- Navigation links on right - hidden on mobile -->
        <div class="hidden md:flex items-center gap-x-8 flex-shrink-0">
          <a
            href={link('/')}
            class="text-[11px] uppercase tracking-gallery transition-all duration-500 ease-out hover:tracking-[0.35em] font-light"
            style={`color: var(--color-text-main); ${(currentPath === baseUrl || currentPath === `${baseUrl}/`) ? 'border-bottom: 1px solid var(--color-text-main);' : ''}`}
          >
            Home
          </a>
          <a
            href={link('/works/')}
            class="text-[11px] uppercase tracking-gallery transition-all duration-500 ease-out hover:tracking-[0.35em] font-light"
            style={`color: var(--color-text-main); ${currentPath.includes("/works") ? 'border-bottom: 1px solid var(--color-text-main);' : ''}`}
          >
            Selected Works
          </a>
          <a
            href={link('/events/')}
            class="text-[11px] uppercase tracking-gallery transition-all duration-500 ease-out hover:tracking-[0.35em] font-light"
            style={`color: var(--color-text-main); ${currentPath.includes("/events") ? 'border-bottom: 1px solid var(--color-text-main);' : ''}`}
          >
            Events
          </a>
          <a
            href={link('/about/')}
            class="text-[11px] uppercase tracking-gallery transition-all duration-500 ease-out hover:tracking-[0.35em] font-light"
            style={`color: var(--color-text-main); ${currentPath.includes("/about") ? 'border-bottom: 1px solid var(--color-text-main);' : ''}`}
          >
            About
          </a>
          <a
            href={link('/contact/')}
            class="text-[11px] uppercase tracking-gallery transition-all duration-500 ease-out hover:tracking-[0.35em] font-light"
            style={`color: var(--color-text-main); ${currentPath.includes("/contact") ? 'border-bottom: 1px solid var(--color-text-main);' : ''}`}
          >
            Contact
          </a>
        </div>
      </div>
    </nav>

    <!-- Mobile menu overlay -->
    <div
      id="mobile-menu"
      class="fixed inset-0 bg-gallery-bone z-40 hidden md:hidden"
    >
      <div class="flex flex-col items-center justify-center h-full space-y-8">
        <a
          href={link('/')}
          class:list={[
            "text-2xl uppercase tracking-gallery transition-opacity font-light",
            (currentPath === baseUrl || currentPath === `${baseUrl}/`) ? "text-ink" : "text-clay-muted hover:text-ink"
          ]}
        >
          Home
        </a>
        <a
          href={link('/works/')}
          class:list={[
            "text-2xl uppercase tracking-gallery transition-opacity font-light",
            currentPath.includes("/works") ? "text-ink" : "text-clay-muted hover:text-ink"
          ]}
        >
          Selected Works
        </a>
        <a
          href={link('/events/')}
          class:list={[
            "text-2xl uppercase tracking-gallery transition-opacity font-light",
            currentPath.includes("/events") ? "text-ink" : "text-clay-muted hover:text-ink"
          ]}
        >
          Events
        </a>
        <a
          href={link('/about/')}
          class:list={[
            "text-2xl uppercase tracking-gallery transition-opacity font-light",
            currentPath.includes("/about") ? "text-ink" : "text-clay-muted hover:text-ink"
          ]}
        >
          About
        </a>
        <a
          href={link('/contact/')}
          class:list={[
            "text-2xl uppercase tracking-gallery transition-opacity font-light",
            currentPath.includes("/contact") ? "text-ink" : "text-clay-muted hover:text-ink"
          ]}
        >
          Contact
        </a>
      </div>
    </div>

    <main class="container mx-auto px-6 lg:px-12 py-24">
      <slot />
    </main>

    <!-- Global Newsletter Footer -->
    <footer class="mt-32 pt-16 pb-24" style="border-top: 1px solid var(--color-line);">
      <div class="flex flex-col items-center text-center">
        <h3 class="text-[10px] uppercase tracking-[0.4em] mb-6" style="color: var(--color-text-main);">
          Studio Updates
        </h3>
        <p class="text-sm font-light mb-8 max-w-md" style="color: var(--color-text-muted);">
          Receive occasional notes on new collections and events.
        </p>
        <form
          action={`https://buttondown.com/api/emails/embed-subscribe/${buttondownUsername}`}
          method="post"
          referrerpolicy="unsafe-url"
          class="flex flex-col md:flex-row gap-4 w-full max-w-sm"
        >
          <input
            type="email"
            name="email"
            placeholder="Email Address"
            required
            class="bg-transparent border-b py-2 text-sm outline-none transition-colors flex-grow"
            style="border-color: var(--color-line); color: var(--color-text-main);"
            onfocus="this.style.borderColor='var(--color-text-main)';"
            onblur="this.style.borderColor='var(--color-line)';"
          />
          <button type="submit" class="btn-zen whitespace-nowrap">Join</button>
        </form>
      </div>
    </footer>

    <script>
      // Mobile menu toggle
      const mobileMenuButton = document.getElementById('mobile-menu-button');
      const mobileMenu = document.getElementById('mobile-menu');

      if (mobileMenuButton && mobileMenu) {
        mobileMenuButton.addEventListener('click', () => {
          const isHidden = mobileMenu.classList.contains('hidden');

          if (isHidden) {
            mobileMenu.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
          } else {
            mobileMenu.classList.add('hidden');
            document.body.style.overflow = '';
          }
        });

        // Close menu when clicking a link
        mobileMenu.querySelectorAll('a').forEach(link => {
          link.addEventListener('click', () => {
            mobileMenu.classList.add('hidden');
            document.body.style.overflow = '';
          });
        });

        // Close menu on escape key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && !mobileMenu.classList.contains('hidden')) {
            mobileMenu.classList.add('hidden');
            document.body.style.overflow = '';
          }
        });
      }
    </script>
  </body>
</html>
