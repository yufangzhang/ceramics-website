---
import BaseLayout from '../layouts/BaseLayout.astro';
import { sanityClient, type Event, type Profile } from '../lib/sanityClient';

const events = await sanityClient.fetch<Event[]>(
  `*[_type == "event"] | order(date desc) {
    _id,
    title,
    date,
    endDate,
    location,
    description,
    link,
    isPast
  }`
);

// Fetch profile for Buttondown username
const profile = await sanityClient.fetch<Profile>(
  "*[_type == 'profile' && _id == 'profile'][0] { buttondownUsername }"
);

const buttondownUsername = profile?.buttondownUsername || 'YOUR_USERNAME_HERE';

const now = new Date();
const currentYear = now.getFullYear();

// Group events by year
const eventsByYear: Record<number, Event[]> = {};
events.forEach(event => {
  const eventDate = new Date(event.date);
  const year = eventDate.getFullYear();
  if (!eventsByYear[year]) {
    eventsByYear[year] = [];
  }
  eventsByYear[year].push(event);
});

// Get sorted years (newest first)
const years = Object.keys(eventsByYear).map(Number).sort((a, b) => b - a);

function formatEventDate(dateString: string, endDateString?: string): string {
  const date = new Date(dateString);
  const month = date.toLocaleDateString('en-US', { month: 'long' });
  const day = date.getDate();

  if (endDateString) {
    const endDate = new Date(endDateString);
    const endDay = endDate.getDate();
    return `${month} ${day} — ${endDay}`;
  }

  return `${month} ${day}`;
}

function formatMonthOnly(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { month: 'long' });
}
---

<BaseLayout title="Events - Yufang Zhang Ceramics" description="Upcoming pottery workshops, exhibitions, and events">
  <main class="min-h-screen bg-gallery-bone px-8 py-24">
    <div class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-12 gap-16 lg:gap-24">

      <!-- Main Content -->
      <div class="md:col-span-9 space-y-32">

        <!-- Page Header -->
        <header class="mb-32">
          <h1 class="text-[11px] uppercase tracking-[0.7em] text-zinc-400 font-sans">Chronology</h1>
        </header>

        <!-- Floating Subscribe Button -->
        <button
          id="subscribe-button"
          class="fixed bottom-8 right-8 bg-ink text-warm-white px-5 py-3 shadow-lg hover:opacity-90 transition-all duration-300 z-50 uppercase tracking-widest text-xs"
          aria-label="Subscribe to updates"
        >
          Subscribe
        </button>

        <!-- Subscribe Modal -->
        <div id="subscribe-modal" class="fixed inset-0 bg-black/50 z-[60] hidden items-center justify-center p-4">
          <div class="bg-warm-white max-w-md w-full p-8 relative">
            <button
              id="close-modal"
              class="absolute top-4 right-4 text-clay-muted hover:text-ink transition-colors text-2xl leading-none"
              aria-label="Close"
            >
              &times;
            </button>

            <h2 class="text-2xl font-sans font-medium uppercase tracking-gallery text-zinc-900 mb-3">
              Stay Updated
            </h2>
            <p class="text-clay-muted mb-6 tracking-wide font-light text-sm leading-relaxed">
              Get notified about upcoming fairs and events. Just occasional updates—no spam. Unsubscribe anytime.
            </p>

            <form
              action={`https://buttondown.com/api/emails/embed-subscribe/${buttondownUsername}`}
              method="post"
              referrerpolicy="unsafe-url"
              class="space-y-4"
            >
              <div>
                <label for="bd-email" class="block text-xs uppercase tracking-widest text-clay-muted mb-2">
                  Email Address
                </label>
                <input
                  type="email"
                  name="email"
                  id="bd-email"
                  placeholder="you@example.com"
                  required
                  class="w-full px-4 py-3 border border-clay-muted/30 focus:border-ink focus:outline-none transition-colors tracking-wide text-sm"
                />
              </div>
              <button
                type="submit"
                class="w-full px-6 py-3 bg-ink text-warm-white hover:opacity-80 transition-opacity uppercase tracking-widest text-xs"
              >
                Subscribe
              </button>
            </form>

            <p class="text-xs text-clay-muted mt-4 tracking-wide text-center">
              Unsubscribe anytime
            </p>
          </div>
        </div>

        <!-- Events by Year -->
        {years.length > 0 ? (
          years.map((year, index) => (
            <section id={`year-${year}`} class={`scroll-mt-24 ${year < currentYear ? 'opacity-80' : ''}`}>
              <h2 class="text-[10px] uppercase tracking-editorial text-zinc-300 mb-16">
                {year === currentYear ? `${year} Highlights` : `${year} Archive`}
              </h2>
              <div class={year === currentYear ? 'space-y-20' : 'space-y-16'}>
                {eventsByYear[year].map((event) => (
                  year === currentYear ? (
                    <!-- Current Year: Detailed Layout -->
                    <div class="group">
                      <span class="text-[9px] uppercase tracking-widest text-zinc-400 block mb-2 font-sans">
                        {formatEventDate(event.date, event.endDate)}
                      </span>
                      <h3 class="text-2xl font-medium text-zinc-900 mb-4 font-sans tracking-tight">
                        {event.title}
                      </h3>
                      {event.description && (
                        <p class="text-sm font-light text-zinc-600 leading-relaxed max-w-md mb-3">
                          {event.description}
                        </p>
                      )}
                      <div class="flex items-center gap-4">
                        <span class="text-[9px] uppercase tracking-widest text-zinc-400">
                          {event.location}
                        </span>
                        {event.link && (
                          <>
                            <span class="text-zinc-300">•</span>
                            <a
                              href={event.link}
                              target="_blank"
                              rel="noopener noreferrer"
                              class="text-[9px] uppercase tracking-wider text-ink hover:opacity-70 transition-opacity inline-flex items-center gap-1"
                            >
                              Learn more
                              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                              </svg>
                            </a>
                          </>
                        )}
                      </div>
                    </div>
                  ) : (
                    <!-- Past Years: Archive Layout -->
                    <div class="flex flex-col gap-1">
                      <span class="text-[9px] uppercase tracking-widest text-zinc-400 font-sans">
                        {formatMonthOnly(event.date)}
                      </span>
                      <h3 class="text-xl font-light text-zinc-800 italic font-serif">
                        {event.title}
                      </h3>
                    </div>
                  )
                ))}
              </div>
            </section>
          ))
        ) : (
          <div class="text-center py-32">
            <p class="text-sm font-light text-zinc-600">
              No events scheduled at the moment.
            </p>
            <p class="text-xs text-zinc-400 mt-4 uppercase tracking-widest">
              New dates announced seasonally via Instagram
            </p>
          </div>
        )}

      </div>

      <!-- Sidebar Navigation -->
      <aside class="hidden md:block md:col-span-3">
        <nav class="sticky top-24 flex flex-col items-end border-r border-zinc-200 pr-6 mr-4">
          <div class="space-y-8 text-right">
            {years.map((year) => (
              <a
                href={`#year-${year}`}
                class="block text-[10px] uppercase tracking-[0.4em] transition-all duration-300 font-sans"
              >
                {year}
              </a>
            ))}
            <a
              href="#archive"
              class="block text-[10px] uppercase tracking-[0.4em] transition-all duration-300 font-sans"
            >
              Archive
            </a>
          </div>
        </nav>
      </aside>

    </div>
  </main>
</BaseLayout>

<style>
  /* Smooth scrolling for the anchor links */
  html {
    scroll-behavior: smooth;
  }
</style>

<script>
  // Subscribe modal functionality
  const subscribeButton = document.getElementById('subscribe-button');
  const subscribeModal = document.getElementById('subscribe-modal');
  const closeModal = document.getElementById('close-modal');

  if (subscribeButton && subscribeModal && closeModal) {
    // Open modal
    subscribeButton.addEventListener('click', () => {
      subscribeModal.classList.remove('hidden');
      subscribeModal.classList.add('flex');
      document.body.style.overflow = 'hidden';
    });

    // Close modal
    const closeModalHandler = () => {
      subscribeModal.classList.add('hidden');
      subscribeModal.classList.remove('flex');
      document.body.style.overflow = '';
    };

    closeModal.addEventListener('click', closeModalHandler);

    // Close on background click
    subscribeModal.addEventListener('click', (e) => {
      if (e.target === subscribeModal) {
        closeModalHandler();
      }
    });

    // Close on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !subscribeModal.classList.contains('hidden')) {
        closeModalHandler();
      }
    });
  }

  // Sidebar navigation active state on scroll
  const observerOptions = {
    root: null,
    rootMargin: '-20% 0px -70% 0px', // Detects when section is in the top-middle of the screen
    threshold: 0
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const id = entry.target.getAttribute('id');
        // Remove active class from all links
        document.querySelectorAll('nav a').forEach(link => {
          link.classList.remove('text-zinc-900', 'font-medium');
          link.classList.add('text-zinc-400');
        });
        // Add active class to the current link
        const activeLink = document.querySelector(`nav a[href="#${id}"]`);
        if (activeLink) {
          activeLink.classList.remove('text-zinc-400');
          activeLink.classList.add('text-zinc-900', 'font-medium');
        }
      }
    });
  }, observerOptions);

  // Observe all sections that have an ID starting with 'year-'
  document.querySelectorAll('section[id^="year-"]').forEach(section => {
    observer.observe(section);
  });
</script>
