---
import BaseLayout from '../layouts/BaseLayout.astro';
import { sanityClient, type Event, type Profile } from '../lib/sanityClient';

const events = await sanityClient.fetch<Event[]>(
  `*[_type == "event"] | order(date desc) {
    _id,
    title,
    date,
    endDate,
    location,
    description,
    link,
    isPast
  }`
);

// Fetch profile for Buttondown username
const profile = await sanityClient.fetch<Profile>(
  "*[_type == 'profile' && _id == 'profile'][0] { buttondownUsername }"
);

const buttondownUsername = profile?.buttondownUsername || 'YOUR_USERNAME_HERE';

const now = new Date();
const currentYear = now.getFullYear();

// Group events by year
const eventsByYear: Record<number, Event[]> = {};
events.forEach(event => {
  const eventDate = new Date(event.date);
  const year = eventDate.getFullYear();
  if (!eventsByYear[year]) {
    eventsByYear[year] = [];
  }
  eventsByYear[year].push(event);
});

// Get sorted years (newest first)
const years = Object.keys(eventsByYear).map(Number).sort((a, b) => b - a);

function formatEventDate(dateString: string, endDateString?: string): string {
  const date = new Date(dateString);
  const month = date.toLocaleDateString('en-US', { month: 'long' });
  const day = date.getDate();
  const time = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

  if (endDateString) {
    const endDate = new Date(endDateString);
    const endDay = endDate.getDate();
    const endTime = endDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

    // Check if it's the same day
    if (date.toDateString() === endDate.toDateString()) {
      return `${month} ${day} • ${time} — ${endTime}`;
    }
    return `${month} ${day} — ${endDay} • ${time} — ${endTime}`;
  }

  return `${month} ${day} • ${time}`;
}

function formatMonthOnly(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { month: 'long' });
}
---

<BaseLayout title="Events - Yufang Zhang Ceramics" description="Upcoming pottery workshops, exhibitions, and events">
  <main class="min-h-screen bg-[#F5F2ED] text-[#27272A] px-8 pt-16 pb-24">
    <div class="max-w-3xl mx-auto">

      <!-- Current & Upcoming Section -->
      <section class="mb-32">
        <div class="flex items-baseline gap-4 mb-12">
          <h2 class="text-[10px] uppercase tracking-[0.4em] text-zinc-900 font-sans">Current & Upcoming</h2>
          <div class="h-[1px] flex-grow bg-zinc-200/60"></div>
        </div>

        {years.length > 0 && eventsByYear[currentYear]?.length > 0 ? (
          <div class="space-y-16">
            {eventsByYear[currentYear].map((event) => (
              <article class="group">
                <div class="flex flex-col space-y-2">
                  <span class="text-[10px] tracking-[0.3em] text-zinc-400 uppercase font-sans font-medium">
                    {formatEventDate(event.date, event.endDate)}, {currentYear}
                  </span>

                  <h2 class="text-2xl text-zinc-900 font-sans tracking-tight font-medium">
                    {event.title}
                  </h2>

                  {event.description && (
                    <p class="text-[15px] font-light text-zinc-600 leading-relaxed max-w-md">
                      {event.description}
                    </p>
                  )}

                  <div class="flex items-center gap-2 pt-2">
                    <svg class="w-3 h-3 text-zinc-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <span class="text-[10px] tracking-widest text-zinc-400 italic">
                      {event.location}
                    </span>
                  </div>
                </div>
              </article>
            ))}
          </div>
        ) : (
          <p class="text-[15px] font-light text-zinc-600">
            No events scheduled at the moment.
          </p>
        )}
      </section>

      <!-- Archive Section -->
      {years.filter(year => year < currentYear).length > 0 && (
        <section class="relative border-l border-zinc-200 ml-1">
          <div class="absolute left-[-1px] top-[-30px] pl-8">
            <h2 class="text-[10px] uppercase tracking-[0.4em] text-zinc-400">Archive</h2>
          </div>

          <div class="space-y-24 pt-4">
            {years.filter(year => year < currentYear).map((year) => (
              <div class="relative pl-12 md:pl-20" id={`year-${year}`}>
                <span class="absolute left-[-1px] top-0 -translate-x-1/2 bg-[#F5F2ED] py-1 text-[10px] font-medium tracking-[0.3em] text-zinc-400 uppercase">
                  {year}
                </span>

                <div class="space-y-12">
                  {eventsByYear[year].map((event) => (
                    <article class="opacity-70 hover:opacity-100 transition-opacity">
                      <span class="text-[10px] uppercase tracking-widest text-zinc-400 font-sans block mb-1">
                        {formatMonthOnly(event.date)}
                      </span>
                      <h3 class="text-lg font-light italic font-serif text-zinc-700">
                        {event.title}
                      </h3>
                    </article>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </section>
      )}

      <!-- Floating Subscribe Button -->
        <button
          id="subscribe-button"
          class="fixed bottom-8 right-8 bg-zinc-800 text-[#F5F2ED] px-5 py-3 shadow-lg hover:opacity-90 transition-all duration-300 z-50 uppercase tracking-widest text-xs"
          aria-label="Subscribe to updates"
        >
          Subscribe
        </button>

        <!-- Subscribe Modal -->
        <div id="subscribe-modal" class="fixed inset-0 bg-black/50 z-[60] hidden items-center justify-center p-4">
          <div class="bg-[#F5F2ED] max-w-md w-full p-8 relative">
            <button
              id="close-modal"
              class="absolute top-4 right-4 text-zinc-500 hover:text-zinc-800 transition-colors text-2xl leading-none"
              aria-label="Close"
            >
              &times;
            </button>

            <h2 class="text-2xl font-sans font-medium uppercase tracking-gallery text-zinc-900 mb-3">
              Stay Updated
            </h2>
            <p class="text-zinc-600 mb-6 tracking-wide font-light text-sm leading-relaxed">
              Get notified about upcoming fairs and events. Just occasional updates—no spam. Unsubscribe anytime.
            </p>

            <form
              action={`https://buttondown.com/api/emails/embed-subscribe/${buttondownUsername}`}
              method="post"
              referrerpolicy="unsafe-url"
              class="space-y-4"
            >
              <div>
                <label for="bd-email" class="block text-xs uppercase tracking-widest text-zinc-500 mb-2">
                  Email Address
                </label>
                <input
                  type="email"
                  name="email"
                  id="bd-email"
                  placeholder="you@example.com"
                  required
                  class="w-full px-4 py-3 border border-zinc-300 focus:border-zinc-800 focus:outline-none transition-colors tracking-wide text-sm bg-transparent"
                />
              </div>
              <button
                type="submit"
                class="w-full px-6 py-3 bg-zinc-800 text-[#F5F2ED] hover:opacity-80 transition-opacity uppercase tracking-widest text-xs"
              >
                Subscribe
              </button>
            </form>

            <p class="text-xs text-zinc-500 mt-4 tracking-wide text-center">
              Unsubscribe anytime
            </p>
          </div>
        </div>

    </div>
  </main>
</BaseLayout>

<script>
  // Subscribe modal functionality
  const subscribeButton = document.getElementById('subscribe-button');
  const subscribeModal = document.getElementById('subscribe-modal');
  const closeModal = document.getElementById('close-modal');

  if (subscribeButton && subscribeModal && closeModal) {
    // Open modal
    subscribeButton.addEventListener('click', () => {
      subscribeModal.classList.remove('hidden');
      subscribeModal.classList.add('flex');
      document.body.style.overflow = 'hidden';
    });

    // Close modal
    const closeModalHandler = () => {
      subscribeModal.classList.add('hidden');
      subscribeModal.classList.remove('flex');
      document.body.style.overflow = '';
    };

    closeModal.addEventListener('click', closeModalHandler);

    // Close on background click
    subscribeModal.addEventListener('click', (e) => {
      if (e.target === subscribeModal) {
        closeModalHandler();
      }
    });

    // Close on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !subscribeModal.classList.contains('hidden')) {
        closeModalHandler();
      }
    });
  }
</script>
