---
import BaseLayout from '../layouts/BaseLayout.astro';
import { sanityClient, type Event, type Profile } from '../lib/sanityClient';

const events = await sanityClient.fetch<Event[]>(
  `*[_type == "event"] | order(date asc) {
    _id,
    title,
    date,
    endDate,
    location,
    description,
    link,
    isPast
  }`
);

// Fetch profile for Buttondown username
const profile = await sanityClient.fetch<Profile>(
  "*[_type == 'profile' && _id == 'profile'][0] { buttondownUsername }"
);

const buttondownUsername = profile?.buttondownUsername || 'YOUR_USERNAME_HERE';

const now = new Date();
const currentYear = now.getFullYear();

// Group events by year
const eventsByYear: Record<number, Event[]> = {};
events.forEach(event => {
  const eventDate = new Date(event.date);
  const year = eventDate.getFullYear();
  if (!eventsByYear[year]) {
    eventsByYear[year] = [];
  }
  eventsByYear[year].push(event);
});

// Get sorted years (newest first)
const years = Object.keys(eventsByYear).map(Number).sort((a, b) => b - a);

function formatEventDate(dateString: string, endDateString?: string): string {
  const date = new Date(dateString);
  const month = date.toLocaleDateString('en-US', { month: 'long' });
  const day = date.getDate();
  const time = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

  if (endDateString) {
    const endDate = new Date(endDateString);
    const endDay = endDate.getDate();
    const endTime = endDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

    // Check if it's the same day
    if (date.toDateString() === endDate.toDateString()) {
      return `${month} ${day} • ${time} — ${endTime}`;
    }
    return `${month} ${day} — ${endDay} • ${time} — ${endTime}`;
  }

  return `${month} ${day} • ${time}`;
}

function formatMonthOnly(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { month: 'long' });
}
---

<BaseLayout title="Events - Yufang Zhang Ceramics" description="Upcoming pottery workshops, exhibitions, and events">
  <main class="min-h-screen px-8 pt-16 pb-24" style="background-color: var(--color-bg); color: var(--color-text-main);">
    <div class="max-w-3xl mx-auto">

      <!-- Current & Upcoming Section -->
      <section class="mb-32">
        <div class="flex items-baseline gap-4 mb-12">
          <h2 class="text-[10px] uppercase tracking-[0.4em] font-sans" style="color: var(--color-text-main);">Current & Upcoming</h2>
          <div class="h-[1px] flex-grow" style="background-color: var(--color-line);"></div>
        </div>

        {years.length > 0 && eventsByYear[currentYear]?.length > 0 ? (
          <div class="space-y-16">
            {eventsByYear[currentYear].map((event) => (
              <article>
                <div class="flex flex-col mb-20">
                  <span class="text-[10px] tracking-[0.3em] text-[#918C86] uppercase font-light mb-3">
                    {formatEventDate(event.date, event.endDate)}, {currentYear}
                  </span>

                  <h2 class="text-[22px] font-medium text-[#45413E] tracking-tight mb-4">
                    {event.title}
                  </h2>

                  {event.description && (
                    <p class="text-sm font-light text-[#71717A] leading-relaxed max-w-md mb-4">
                      {event.description}
                    </p>
                  )}

                  <div class="flex flex-col gap-3">
                    <div class="flex items-center gap-2">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" style="color: var(--color-line);">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                      </svg>
                      <span class="text-[10px] tracking-[0.15em] text-[#918C86] italic">
                        {event.location}
                      </span>
                    </div>

                    {event.link && (
                      <a
                        href={event.link}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="text-[10px] tracking-[0.15em] uppercase hover:opacity-70 transition-opacity inline-flex items-center gap-2"
                        style="color: var(--color-text-main);"
                      >
                        Learn More →
                      </a>
                    )}
                  </div>
                </div>
              </article>
            ))}
          </div>
        ) : (
          <p class="text-[15px] font-light" style="color: var(--color-text-muted);">
            No events scheduled at the moment.
          </p>
        )}
      </section>

      <!-- Archive Section -->
      {years.filter(year => year < currentYear).length > 0 && (
        <section class="relative ml-1" style="border-left: 1px solid var(--color-line);">
          <div class="absolute left-[-1px] top-[-30px] pl-8">
            <h2 class="text-[10px] uppercase tracking-[0.4em]" style="color: var(--color-text-muted);">Archive</h2>
          </div>

          <div class="space-y-24 pt-4">
            {years.filter(year => year < currentYear).map((year) => (
              <div class="relative pl-12 md:pl-20" id={`year-${year}`}>
                <span class="absolute left-[-1px] top-0 -translate-x-1/2 py-1 text-[10px] font-medium tracking-[0.3em] uppercase" style="background-color: var(--color-bg); color: var(--color-text-muted);">
                  {year}
                </span>

                <div class="space-y-12">
                  {eventsByYear[year].map((event) => (
                    <article class="opacity-70 hover:opacity-100 transition-opacity">
                      <span class="text-[10px] uppercase tracking-widest font-sans block mb-1" style="color: var(--color-text-muted);">
                        {formatMonthOnly(event.date)}
                      </span>
                      <h3 class="text-lg font-light italic font-serif" style="color: var(--color-text-muted);">
                        {event.title}
                      </h3>
                    </article>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </section>
      )}

    </div>
  </main>
</BaseLayout>
